# Project

<p align="center">
  <img src="https://github.com/JorgeFreire95/rep-drill/blob/main/fases/fase_2/evidencias_proyecto/evidencias_documentacion/logos/rep-drill_light_logo.svg" width="50%" height="50%" />
</p>

## Repository

Este repositorio contiene el source code del Software de GestiÃ³n para la Sala de Ventas: Lubricentro **Rep-Drill**.

## Main objectives of the Solution

- Contribuir a la ingenierÃ­a y mejoramiento continuo de los procesos estratÃ©gicos y operacionales de la entidad comercial Rep-Drill, tras la implementaciÃ³n de una infraestructura para optimizar el registro y control de los productos por parte del Ã¡rea operacional.
- Ofrecer una soluciÃ³n de calidad hacia los empleados.
- Reducir los tiempos destinados para registrar y modificar los productos.
- Mejorar el proceso operacional para los usuarios finales.
- Instar a los empleados a utilizar el software para realizar la gestiÃ³n de operaciones empresariales.

## Specific objectives of the Solution

| ID | DescripciÃ³n |
| ------------- | ------------- |
| SPC-OBJ-PROJ-01_01 | Implementar y facilitar la gestiÃ³n del inventario de productos. |
| SPC-OBJ-PROJ-01_02 | Reportar la gestiÃ³n del inventario de productos. |
| SPC-OBJ-PROJ-01_03 | Gestionar el control de acceso de los usuarios. |
| SPC-OBJ-PROJ-01_04 | Implementar el sistema de notificaciones automatizado, a fin de informar la baja cantidad de cierto producto. |
| SPC-OBJ-PROJ-01_05 | Integrar el asistente virtual para el asesoramiento de las consultas de los usuarios. |
| SPC-OBJ-PROJ-01_06 | Analizar, evaluar y reportar los insights del flujo de productos. |

## Transversal objectives of the Solution

| ID | DescripciÃ³n |
| ------------- | ------------- |
| TRANS-OBJ-PROJ-01_01 | Mejorar y proyectar las necesidades administrativas de la entidad comercial. |
| TRANS-OBJ-PROJ-01_02 | Capacitar al personal para asegurar que estÃ©n preparados para manipular los mÃ³dulos implementados. |
| TRANS-OBJ-PROJ-01_03 | Controlar y monitorear constantemente que se estÃ©n aplicando todos los estÃ¡ndares internacionales que deben ser implementados en el proyecto. |

## Functionality

| ID | Nombre | DescripciÃ³n |
| ------------- | ------------- | ------------- |
| FR-01 | GestiÃ³n Productos | Registrar, modificar e inventariar productos. |
| FR-02 | GestiÃ³n Reportes | Generar reportes de inventario. |
| FR-03 | GestiÃ³n Proveedores | Visibilizar y registrar proveedores. |
| FR-04 | GestiÃ³n AutenticaciÃ³n | Autenticar cuenta de usuario. |
| FR-05 | GestiÃ³n Usuarios | Crear y administrar perfiles de usuario. |
| FR-06 | GestiÃ³n Notificaciones | Notificar usuarios del bajo stock de productos. |
| FR-07 | GestiÃ³n Autoayuda | Asesorar consultas del usuario. |
| FR-08 | GestiÃ³n Proyecciones | Proyectar grÃ¡ficos del flujo de artÃ­culos. |
| FR-09 | GestiÃ³n Ventas | Visualizar ventas realizadas. |
| FR-10 | GestiÃ³n Ã“rdenes | Mostrar y generar Ã³rdenes de compra. |
| FR-11 | GestiÃ³n AuditorÃ­a | Gestionar auditorÃ­as. |

## Task List

### 1.	Fase 1: DefiniciÃ³n Proyecto APT: Inicio y OrganizaciÃ³n.
#### 1.1.	IteraciÃ³n / Sprint 0: AnÃ¡lisis, EspecificaciÃ³n y PlanificaciÃ³n. 

- [x] 1.1.	IteraciÃ³n / Sprint 0: AnÃ¡lisis, EspecificaciÃ³n y PlanificaciÃ³n. 
  - [x] 1.1.1.	GestiÃ³n de AnÃ¡lisis.
  - [x] 1.1.2.	GestiÃ³n de EspecificaciÃ³n.
  - [x] 1.1.3.	GestiÃ³n de PlanificaciÃ³n.
  - [x] 1.1.4.	GestiÃ³n de PresentaciÃ³n.
  - [x] 1.1.5.	GestiÃ³n de ExposiciÃ³n.

### 2.	Fase 2: Desarrollo Proyecto APT: EjecuciÃ³n y Control.
#### 2.1.	IteraciÃ³n / Sprint 0.5: DiseÃ±o y GestaciÃ³n.

- [x] 2.1.	IteraciÃ³n / Sprint 0.5: DiseÃ±o y GestaciÃ³n.
  - [x] 2.1.1.	EjecuciÃ³n y Control de GestiÃ³n del Modelamiento, DiseÃ±o y Arquitectura.
  - [x] 2.1.2.	EjecuciÃ³n y Control de GestiÃ³n de la ImplementaciÃ³n Ambiente de Desarrollo.

#### 2.2.	IteraciÃ³n / Sprint 1: ConstrucciÃ³n e Incremento de GestiÃ³n Productos, Reportes y Proveedores.

- [x] 2.2.	IteraciÃ³n / Sprint 1: ConstrucciÃ³n e Incremento de GestiÃ³n Productos, Reportes y Proveedores.
  - [x] 2.2.1.	EjecuciÃ³n y Control de GestiÃ³n Productos.
  - [x] 2.2.2.	EjecuciÃ³n y Control de GestiÃ³n Reportes.
  - [x] 2.2.3.	EjecuciÃ³n y Control de GestiÃ³n Proveedores.

#### 2.3.	IteraciÃ³n / Sprint 2: ConstrucciÃ³n e Incremento de GestiÃ³n AutenticaciÃ³n y Usuarios.

- [x] 2.3.	IteraciÃ³n / Sprint 2: ConstrucciÃ³n e Incremento de GestiÃ³n AutenticaciÃ³n y Usuarios.
  - [x] 2.3.1.	EjecuciÃ³n y Control de GestiÃ³n AutenticaciÃ³n.
  - [x] 2.3.2.	EjecuciÃ³n y Control de GestiÃ³n Usuarios.

#### 2.4.	IteraciÃ³n / Sprint 3: ConstrucciÃ³n e Incremento de GestiÃ³n Notificaciones, Autoayuda y Proyecciones.

- [x] 2.4.	IteraciÃ³n / Sprint 3: ConstrucciÃ³n e Incremento de GestiÃ³n Notificaciones, Autoayuda y Proyecciones.
  - [x] 2.4.1.	EjecuciÃ³n y Control de GestiÃ³n Notificaciones.
  - [x] 2.4.2.	EjecuciÃ³n y Control de GestiÃ³n Autoayuda.
  - [x] 2.4.3.	EjecuciÃ³n y Control de GestiÃ³n Proyecciones.

#### 2.5.	IteraciÃ³n / Sprint 4: ConstrucciÃ³n e Incremento de GestiÃ³n Ventas, Ã“rdenes y AuditorÃ­a.

- [x] 2.5.	IteraciÃ³n / Sprint 4: ConstrucciÃ³n e Incremento de GestiÃ³n Ventas, Ã“rdenes y AuditorÃ­a.
  - [x] 2.5.1.	EjecuciÃ³n y Control de GestiÃ³n Ventas.
  - [x] 2.5.2.	EjecuciÃ³n y Control de GestiÃ³n Ã“rdenes.
  - [x] 2.5.3.	EjecuciÃ³n y Control de GestiÃ³n AuditorÃ­a.

#### 2.6.	IteraciÃ³n / Sprint 4.5: ImplantaciÃ³n y CapacitaciÃ³n.

- [ ] 2.6.	IteraciÃ³n / Sprint 4.5: ImplantaciÃ³n y CapacitaciÃ³n.
  - [ ] 2.6.1.	GestiÃ³n de ImplantaciÃ³n.
  - [ ] 2.6.2.	GestiÃ³n de CapacitaciÃ³n.

### 3.	Fase 3: PresentaciÃ³n Proyecto APT: Cierre y Retrospectiva.
#### 3.1.	IteraciÃ³n / Sprint 4.9: Cierre y Retrospectiva.

- [ ] 3.1.	IteraciÃ³n / Sprint 4.9: Cierre y Retrospectiva.
  - [ ] 3.1.1.	GestiÃ³n de Cierre.
  - [ ] 3.1.2.	GestiÃ³n de ExposiciÃ³n.

## Scrum Board
### [Trello](https://trello.com/invite/b/6917b18d5b9f85f94f882575/ATTIf380119340f89fcbed7a90d8db750e15BA38C715/rep-drill)

# ğŸš€ Rep Drill - Sistema de GestiÃ³n Empresarial

Sistema empresarial completo con arquitectura de microservicios, predicciÃ³n de demanda con Prophet, y frontend React moderno. Ideal para gestiÃ³n de inventario multi-bodega, ventas, personas y anÃ¡lisis predictivo.

## ğŸ“‹ Tabla de Contenidos

- [Arquitectura del Sistema](#-arquitectura-del-sistema)
- [CaracterÃ­sticas Principales](#-caracterÃ­sticas-principales)
- [Stack TecnolÃ³gico](#-stack-tecnolÃ³gico)
- [Inicio RÃ¡pido](#-inicio-rÃ¡pido)
- [Microservicios](#-microservicios)
- [Frontend](#-frontend)
- [Seguridad](#-seguridad)
- [Monitoreo y Observabilidad](#-monitoreo-y-observabilidad)
- [Desarrollo](#-desarrollo)
- [Despliegue en ProducciÃ³n](#-despliegue-en-producciÃ³n)
- [API Documentation](#-api-documentation)
- [DocumentaciÃ³n Adicional](#-documentaciÃ³n-adicional)
- [ContribuciÃ³n](#-contribuciÃ³n)
- [Licencia](#-licencia)

---

## ğŸ—ï¸ Arquitectura del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend React (Port 5173)                â”‚
â”‚       Vite + TypeScript + Tailwind CSS + Recharts + PWA      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Nginx Gateway (Port 80/443)                â”‚
â”‚     Reverse Proxy + SSL/TLS + Static Files + Load Balance    â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
  â”‚       â”‚        â”‚        â”‚        â”‚        â”‚       â”‚
  â–¼       â–¼        â–¼        â–¼        â–¼        â–¼       â–¼
â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Authâ”‚ â”‚Persâ”‚  â”‚Inv â”‚  â”‚Ventâ”‚  â”‚Analyâ”‚  â”‚Chatâ”‚  â”‚ Ollama   â”‚
â”‚8001â”‚ â”‚8004â”‚  â”‚8003â”‚  â”‚8002â”‚  â”‚8005â”‚  â”‚8006â”‚  â”‚ 11434    â”‚
â””â”€â”¬â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜  â””â”€â”¬â”€â”€â”˜  â””â”€â”¬â”€â”€â”˜  â””â”€â”¬â”€â”€â”˜  â””â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚      â”‚       â”‚       â”‚       â”‚       â”‚
  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚       â”‚
                                           â–¼       â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚PostgreSQLâ”‚ â”‚ Redis  â”‚
                                    â”‚   5432   â”‚ â”‚  6379  â”‚
                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                         â”‚           â”‚
                                         â–¼           â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Celery â”‚  â”‚ Celery â”‚
                                    â”‚ Worker â”‚  â”‚  Beat  â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CaracterÃ­sticas ArquitectÃ³nicas:**
- **Microservicios**: 6 servicios independientes con Django REST Framework
- **Base de Datos**: PostgreSQL 15 Alpine con conexiones optimizadas y pooling
- **Cache & Broker**: Redis 7 para Celery, cachÃ© de Prophet y sesiones
- **API Gateway**: Nginx con SSL/TLS ready, rate limiting y security headers
- **Workers AsÃ­ncronos**: Celery + Beat para mÃ©tricas y forecasting automatizado
- **LLM Local**: Ollama para chatbot inteligente sin dependencia de APIs externas
- **Frontend Moderno**: React 18 SPA con lazy loading y code splitting

---

## âœ¨ CaracterÃ­sticas Principales

### ğŸ” AutenticaciÃ³n y AutorizaciÃ³n
- JWT con refresh tokens (SimpleJWT)
- Roles y permisos granulares
- Sesiones de usuario rastreables
- Blacklist de tokens en logout
- Middleware de auditorÃ­a de seguridad

### ğŸ‘¥ GestiÃ³n de Personas
- **Clientes**: Base de datos unificada con bÃºsqueda rÃ¡pida (por telÃ©fono, email, nombre)
- **Empleados**: VinculaciÃ³n con usuarios del sistema
- **Proveedores**: GestiÃ³n de contactos y asociaciÃ³n con productos
- **Representantes**: Seguimiento de equipos de ventas

### ğŸ“¦ Inventario Multi-Bodega
- **Productos**: SKU, categorÃ­as, precios, stock por bodega
- **Bodegas**: GestiÃ³n de ubicaciones y capacidad
- **Alertas de Stock**: AutomÃ¡ticas con niveles crÃ­ticos y de advertencia
- **Reorden Inteligente**: Calculado con ROP (Reorder Point), Safety Stock, EOQ

### ğŸ’° Ventas
- **Ã“rdenes de Venta**: Flujo completo (draft â†’ confirmed â†’ completed â†’ cancelled)
- **ActualizaciÃ³n AutomÃ¡tica**: Descuenta inventario al confirmar orden
- **EnvÃ­os**: Tracking con estados (pending â†’ in_transit â†’ delivered)
- **Pagos**: MÃºltiples mÃ©todos (efectivo, transferencia, crÃ©dito)
- **ValidaciÃ³n de Stock**: Pre-validaciÃ³n antes de confirmar Ã³rdenes

### ğŸ“Š Analytics y Forecasting (Prophet)
- **MÃ©tricas Diarias**: Ventas, Ã³rdenes, ingresos (calculadas por Celery cada hora)
- **Demanda de Productos**: Tendencias y velocidad de rotaciÃ³n
- **Prophet Forecasting**:
  - Ventas totales (company-wide)
  - Por producto individual
  - Por categorÃ­a agregada
  - Por bodega
  - Top N productos con mayor demanda
- **Recomendaciones de Restock**: Prioridad (critical, high, medium, low) con cÃ¡lculo de stockout risk
- **Reportes**: Kardex, ventas, rentabilidad (con exportaciÃ³n PDF/Excel)
- **Dashboard**: EstadÃ­sticas en tiempo real con mÃ©tricas consolidadas

### ğŸ¤– Chatbot Inteligente (Ollama)
- **LLM Local**: Gemma2 2B sin dependencia de APIs cloud
- **Streaming SSE**: Respuestas en tiempo real con Server-Sent Events
- **Memoria Conversacional**: Contexto persistente en Redis
- **IntegraciÃ³n con Negocio**: Consultas de inventario, ventas, clientes en lenguaje natural
- **Sin Costos de API**: Modelo corriendo localmente con Ollama

### ğŸ”„ Procesamiento AsÃ­ncrono
- **Celery Beat**: Tareas programadas
  - `calculate_daily_metrics`: cada hora
  - `calculate_product_demand`: cada 2 horas
  - `calculate_inventory_turnover`: diario
  - `save_daily_forecasts`: 5:00 AM diario
  - `generate_restock_recommendations`: 6:00 AM diario
  - `update_forecast_accuracy`: 7:00 AM diario
  - `cleanup_old_metrics`: semanal
  - `check_service_health`: cada 5 minutos
- **Celery Worker**: Procesamiento paralelo con 2 workers por servicio

---

## ğŸ› ï¸ Stack TecnolÃ³gico

### Backend
- **Framework**: Django 4.2 + Django REST Framework 3.14
- **Base de Datos**: PostgreSQL 15 Alpine con pgAdmin (opcional)
- **Cache/Broker**: Redis 7 Alpine con persistencia AOF
- **Task Queue**: Celery 5.3 + Celery Beat (scheduler)
- **WSGI Server**: Gunicorn (3 workers/servicio, timeout 120s)
- **ML Library**: Prophet 1.1 (time series forecasting)
- **LLM**: Ollama + Gemma2 2B (chatbot local)
- **Authentication**: JWT (SimpleJWT) con refresh token blacklist
- **Testing**: pytest + pytest-django + pytest-cov + coverage
- **ValidaciÃ³n**: Frictionless (CSV quality), Pydantic (data models)
- **Monitoring**: Prometheus + Grafana (opcional)

### Frontend
- **Framework**: React 18.3.1
- **Build Tool**: Vite 7.1.7
- **Language**: TypeScript 5.9.3
- **Styling**: Tailwind CSS 3.4.18
- **Routing**: React Router 6.22.0
- **Charts**: Recharts 3.3.0
- **HTTP Client**: Axios 1.12.2
- **Icons**: Lucide React 0.545.0
- **Export**: jsPDF 3.0.3, XLSX 0.18.5
- **State Management**: React hooks (useState, useEffect, useContext)

### Infrastructure
- **Containerization**: Docker + Docker Compose
- **Reverse Proxy**: Nginx Alpine
- **Web Server (Prod)**: Nginx (servir React build)
- **Networking**: Docker bridge network (micro_net)
- **Volumes**: Persistencia para PostgreSQL, Redis, static files

---

## ğŸš€ Inicio RÃ¡pido

### Prerrequisitos
- Docker Desktop 4.x o superior
- Git
- PowerShell (Windows) o Bash (Linux/Mac)

### 1. Clonar el Repositorio
```powershell
git clone https://github.com/RazorZ7X/rep_drill.git
cd rep_drill
```

### 2. Configurar Variables de Entorno
Crea un archivo `.env` en la raÃ­z:

```env
# Database
DB_NAME=rep_drill_db
DB_USER=usuario
DB_PASSWORD=contraseÃ±a_segura_aquÃ­

# Django
DJANGO_SECRET_KEY=tu_secret_key_super_segura_aquÃ­
JWT_SIGNING_KEY=tu_jwt_signing_key_aquÃ­
DEBUG=False
ALLOWED_HOSTS=localhost,127.0.0.1

# Redis
REDIS_PASSWORD=redis_password_aquÃ­

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# Analytics
ANALYTICS_RETENTION_DAYS=365
ANALYTICS_CALCULATION_BATCH_SIZE=100
```

### 3. Levantar Todos los Servicios
```powershell
docker compose up -d --build
```

Esto iniciarÃ¡:
- PostgreSQL (puerto 5432)
- Redis (puerto 6379)
- Auth Service (puerto 8001)
- Personas Service (puerto 8004)
- Inventario Service (puerto 8003)
- Ventas Service (puerto 8002)
- Analytics Service (puerto 8005)
- Celery Worker + Beat
- Nginx Gateway (puerto 80)
- Frontend React (puerto 5173)

### 4. Ejecutar Migraciones
```powershell
docker compose exec auth python manage.py migrate
docker compose exec personas python manage.py migrate
docker compose exec inventario python manage.py migrate
docker compose exec ventas python manage.py migrate
docker compose exec analytics python manage.py migrate
docker compose exec chatbot python manage.py migrate
```

### 5. Crear Superusuario (Opcional)
```powershell
docker compose exec auth python manage.py createsuperuser
```

### 6. Acceder al Sistema
- **Frontend**: http://localhost:5173
- **Nginx Gateway**: http://localhost
- **Auth API**: http://localhost/auth/api/v1/
- **Personas API**: http://localhost/personas/api/
- **Inventario API**: http://localhost/inventario/api/
- **Ventas API**: http://localhost/ventas/api/
- **Analytics API**: http://localhost/analytics/api/
- **Chatbot API**: http://localhost/chatbot/api/chatbot/ (SSE streaming)
- **Ollama LLM**: http://localhost:11434 (primer uso descarga Gemma2 ~1.6GB)

### 7. Poblar con Datos de Prueba (Opcional)
```powershell
# Inventario
docker compose exec inventario python populate_automotive.py

# Ventas
docker compose exec ventas python populate_automotive_sales.py

# Analytics (requiere datos de inventario y ventas)
docker compose exec analytics python populate_inventory_clean.py
```

---

## ğŸ§© Microservicios

### 1. **Auth Service** (Puerto 8001)
**PropÃ³sito**: AutenticaciÃ³n centralizada, gestiÃ³n de usuarios, roles y permisos.

**Endpoints Principales**:
- `POST /api/v1/auth/login/` - Login con email/password
- `POST /api/v1/auth/token/refresh/` - Renovar access token
- `POST /api/v1/auth/logout/` - Logout (blacklist refresh token)
- `GET /api/v1/auth/profile/` - Perfil del usuario autenticado
- `PATCH /api/v1/auth/profile/` - Actualizar perfil
- `POST /api/v1/auth/register/` - Registro de nuevos usuarios
- `GET /api/v1/auth/users/permissions/` - Permisos del usuario
- `GET /api/v1/auth/admin/users/` - Listar usuarios (admin)
- `POST /api/v1/auth/admin/users/` - Crear usuario (admin)
- `GET /api/v1/auth/roles/` - Listar roles
- `GET /api/v1/auth/permissions/` - Listar permisos

**Modelos**:
- `User` (CustomUser con roles)
- `Role` (admin, vendedor, bodeguero, etc.)
- `Permission` (read_products, create_sales, etc.)
- `RolePermission` (many-to-many)
- `UserSession` (tracking de sesiones)

**AutenticaciÃ³n**: JWT (access token 30min, refresh token 7 dÃ­as)

---

### 2. **Personas Service** (Puerto 8004)
**PropÃ³sito**: GestiÃ³n de clientes, proveedores, empleados y representantes.

**Endpoints Principales**:
- `GET /api/personas/` - Listar personas (con filtros es_cliente, es_proveedor)
- `POST /api/personas/` - Crear persona
- `GET /api/personas/{id}/` - Detalle de persona
- `PATCH /api/personas/{id}/` - Actualizar persona
- `DELETE /api/personas/{id}/` - Eliminar persona
- `GET /api/personas/search_customers/` - BÃºsqueda rÃ¡pida de clientes
- `GET /api/customers/` - Clientes (legacy)
- `GET /api/employees/` - Empleados (legacy)
- `GET /api/suppliers/` - Proveedores (legacy, usar inventario/suppliers para nuevo)
- `GET /api/reps/` - Representantes (legacy)

**Modelos**:
- `Persona` (unificado: nombre, documento, telÃ©fono, email, direcciÃ³n, es_cliente, es_proveedor)
- `Customer`, `Employee`, `Supplier`, `Rep` (legacy, mantenidos por compatibilidad)

**Permisos**:
- `CanManageCustomers`
- `CanManageEmployees`
- `CanManageSuppliers`
- `CanManageReps`

---

### 3. **Inventario Service** (Puerto 8003)
**PropÃ³sito**: GestiÃ³n de productos, bodegas, categorÃ­as, stock, reÃ³rdenes y proveedores.

**Endpoints Principales**:
- `GET /api/products/` - Listar productos
- `POST /api/products/` - Crear producto
- `GET /api/products/{id}/` - Detalle de producto
- `PATCH /api/products/{id}/` - Actualizar producto
- `DELETE /api/products/{id}/` - Eliminar producto
- `GET /api/products/{id}/stock_by_warehouse/` - Stock por bodega
- `POST /api/products/{id}/adjust_stock/` - Ajustar stock manualmente
- `GET /api/warehouses/` - Listar bodegas
- `POST /api/warehouses/` - Crear bodega
- `GET /api/categories/` - Listar categorÃ­as
- `POST /api/categories/` - Crear categorÃ­a
- `GET /api/stock-alerts/` - Alertas de stock bajo
- `GET /api/stock-alerts/count/` - Contador de alertas (crÃ­ticas, advertencias)
- `GET /api/reorders/` - Solicitudes de reorden
- `POST /api/reorders/` - Crear solicitud de reorden
- `PATCH /api/reorders/{id}/` - Actualizar estado (requested â†’ ordered â†’ received)
- `GET /api/suppliers/` - Listar proveedores
- `POST /api/suppliers/` - Crear proveedor
- `GET /api/suppliers/{id}/products/` - Productos del proveedor
- `POST /api/suppliers/{id}/attach_product/` - Asociar producto a proveedor
- `GET /api/suppliers/{id}/purchases/` - Historial de compras
- `GET /api/suppliers/{id}/performance/` - MÃ©tricas de desempeÃ±o

**Modelos**:
- `Product` (SKU, nombre, precio, categorÃ­a, proveedor)
- `Warehouse` (nombre, ubicaciÃ³n, capacidad)
- `Category` (nombre, descripciÃ³n)
- `Stock` (producto, bodega, cantidad, mÃ­n/mÃ¡x)
- `StockMovement` (entrada/salida, razÃ³n, cantidad, auditorÃ­a)
- `ReorderRequest` (producto, proveedor, cantidad, estado, prioridad)
- `Supplier` (nombre, email, telÃ©fono, rating)

**AuditorÃ­a**: Middleware `CurrentActorMiddleware` para rastrear quiÃ©n hace cambios.

---

### 4. **Ventas Service** (Puerto 8002)
**PropÃ³sito**: Ã“rdenes de venta, envÃ­os, pagos y actualizaciÃ³n automÃ¡tica de inventario.

**Endpoints Principales**:
- `GET /api/orders/` - Listar Ã³rdenes
- `POST /api/orders/` - Crear orden (draft)
- `GET /api/orders/{id}/` - Detalle de orden
- `PATCH /api/orders/{id}/` - Actualizar orden
- `POST /api/orders/{id}/confirm/` - Confirmar orden (descuenta stock)
- `POST /api/orders/{id}/cancel/` - Cancelar orden (reversa stock si estaba confirmed)
- `GET /api/orders/{id}/items/` - Items de la orden
- `POST /api/orders/{id}/add_item/` - Agregar item
- `GET /api/shipments/` - Listar envÃ­os
- `POST /api/shipments/` - Crear envÃ­o
- `PATCH /api/shipments/{id}/` - Actualizar estado de envÃ­o
- `GET /api/payments/` - Listar pagos
- `POST /api/payments/` - Registrar pago
- `GET /api/order-events/` - Eventos de Ã³rdenes (SSE para real-time)

**Modelos**:
- `Order` (cliente, vendedor, total, estado: draft/confirmed/completed/cancelled)
- `OrderItem` (producto, cantidad, precio unitario, subtotal)
- `Shipment` (orden, mÃ©todo, direcciÃ³n, estado: pending/in_transit/delivered)
- `Payment` (orden, monto, mÃ©todo: efectivo/transferencia/crÃ©dito, fecha)

**IntegraciÃ³n con Inventario**:
- Al confirmar orden: llama `adjust_stock` en inventario service
- Al cancelar orden confirmada: reversa ajuste de stock

**Permisos**:
- `CanManageOrders`
- `CanManageShipments`
- `CanManagePayments`

---

### 5. **Analytics Service** (Puerto 8005)
**PropÃ³sito**: MÃ©tricas agregadas, Prophet forecasting, recomendaciones de restock, reportes.

**Endpoints Principales**:

**MÃ©tricas**:
- `GET /api/metrics/daily-sales/` - MÃ©tricas diarias de ventas
- `GET /api/metrics/product-demand/` - Demanda de productos
- `GET /api/metrics/inventory-turnover/` - RotaciÃ³n de inventario
- `GET /api/metrics/restock-recommendations/` - Recomendaciones de reorden

**Prophet Forecasting**:
- `GET /api/prophet/dashboard-stats/` - Stats para dashboard (crÃ­ticos, urgentes, accuracy)
- `GET /api/prophet/sales-forecast/` - Forecast de ventas totales
- `GET /api/prophet/product-forecast/?product_id=X` - Forecast por producto
- `GET /api/prophet/top-products-forecast/?top=10` - Top productos con forecast
- `GET /api/prophet/category-forecast/?category_id=X` - Forecast por categorÃ­a
- `GET /api/prophet/warehouse-forecast/?warehouse_id=X` - Forecast por bodega
- `GET /api/prophet/forecast-components/` - Componentes de tendencia/estacionalidad

**Restock**:
- `GET /api/restock/recommendations/` - Recomendaciones detalladas
- `POST /api/restock/bulk-generate/` - Generar recomendaciones masivas

**Reportes**:
- `GET /api/reports/kardex/?product_id=X&warehouse_id=Y` - Kardex (movimientos)

---

### 6. **Chatbot de Forecasting (Ollama, Puerto 8006)**
**PropÃ³sito**: Asistente conversacional que analiza mÃ©tricas y grÃ¡ficos de forecasting (ventas e inventario) usando un LLM local vÃ­a Ollama.

**CaracterÃ­sticas**
- Streaming en tiempo real (SSE) con botÃ³n Cancelar en el frontend
- Reintento automÃ¡tico con refresh de token cuando expira el access token
- Preguntas rÃ¡pidas pÃºblicas (sin autenticaciÃ³n)
- Contexto de negocio: top N productos, Ãºltimos dÃ­as, KPIs de ventas/inventario
- MÃ©tricas internas: tokens usados, tiempo de respuesta, errores/dÃ­a

**Endpoints** (prefijo Nginx: `/chatbot` â†’ servicio interno: `/api/chatbot/`)
- `POST /api/chatbot/ask/` â€” respuesta completa (no streaming)
- `POST /api/chatbot/ask-stream/` â€” respuesta en streaming (text/event-stream)
- `GET  /api/chatbot/quick-questions/` â€” preguntas sugeridas (pÃºblico)
- `GET  /api/chatbot/history/?session_id=UUID` â€” historial de la sesiÃ³n
- `DELETE /api/chatbot/clear/?session_id=UUID` â€” finalizar sesiÃ³n
- `GET  /api/chatbot/health/` â€” estado (Ollama, DB, Redis, Analytics)

**Variables de entorno relevantes** (ya incluidas en `docker-compose.yml`)
- `JWT_SIGNING_KEY` â€” debe ser la misma en todos los servicios (Auth, Chatbot, Analytics). Importante para evitar 401.
- `OLLAMA_URL` â€” por defecto `http://ollama:11434` (contenedor local)
- `OLLAMA_MODEL` â€” por defecto `llama3.2:3b` (ligero y rÃ¡pido)
- `OLLAMA_TIMEOUT` â€” tiempo de espera de conexiÃ³n/lectura
- `CHATBOT_MAX_TOKENS`, `CHATBOT_TEMPERATURE` â€” control de generaciÃ³n

**Notas de operaciÃ³n**
- El primer request puede tardar mÃ¡s: Ollama descargarÃ¡ el modelo si no existe.
- El Nginx Gateway estÃ¡ configurado para SSE: `proxy_buffering off`, `gzip off`, `proxy_read_timeout 3600s`.
- El endpoint de streaming emite eventos `start`, `chunk`, `done`, `error`.

**Frontend**
- Panel del chatbot disponible desde `http://localhost/app/` una vez autenticado.
- El cliente de streaming usa `fetch + ReadableStream` con `AbortController` (Cancel), manejo de `401 â†’ refresh â†’ retry` y ETA/elapsed.

**SoluciÃ³n de problemas (401 Unauthorized)**
1) Cierra sesiÃ³n y vuelve a iniciar en `http://localhost/app`.
2) Asegura que `JWT_SIGNING_KEY` sea el mismo para `auth`, `chatbot` y `analytics`.
3) Verifica en la solicitud que se envÃ­e `Authorization: Bearer <access>`.
4) Si persiste, revisa logs de `rep_drill_chatbot` para mensajes de `Unauthorized` y compÃ¡rtelos.

Para mÃ¡s detalles operativos y comandos de despliegue, ver las guÃ­as siguientes.

---

## ğŸ“š Chatbot con Ollama 

El proyecto incluye un microservicio de Chatbot que utiliza un LLM local con Ollama para responder preguntas sobre tu negocio y los grÃ¡ficos de forecasting. Trabaja sobre los datos calculados por el servicio de Analytics y estÃ¡ completamente integrado al gateway Nginx y la autenticaciÃ³n JWT.

Funciones clave
- AnÃ¡lisis conversacional de KPIs y proyecciones
- Streaming SSE con cancelaciÃ³n desde el cliente
- Manejo de tokens expandidos (refresh automÃ¡tico)
- Preguntas rÃ¡pidas pÃºblicas para onboarding

TecnologÃ­as
- Django + DRF, SimpleJWT
- Ollama (llama3.2:3b por defecto)
- Nginx (SSE/CORS/Authorization forwarding)
- React + TypeScript (cliente streaming)

---

## ğŸ§­ GuÃ­as rÃ¡pidas del Chatbot

- GuÃ­a rÃ¡pida: `CHATBOT_QUICKSTART.md`
- Despliegue y configuraciÃ³n avanzada: `DEPLOYMENT_CHATBOT.md`

Ambos documentos cubren:
- Modelos recomendados de Ollama, cÃ³mo cambiarlos y precargarlos
- Variables de entorno y timeouts
- Rutas y CORS en Nginx
- Pruebas de salud y verificaciÃ³n end-to-end
- `GET /api/reports/sales/?period=month` - Reporte de ventas
- `GET /api/reports/profitability/?period=month` - Reporte de rentabilidad

**Dashboard**:
- `GET /api/dashboard/overview/` - Resumen general
- `GET /api/dashboard/sales-trend/` - Tendencia de ventas
- `GET /api/dashboard/top-products/` - Top productos vendidos

**Acciones Manuales**:
- `POST /api/actions/calculate-metrics/` - Forzar cÃ¡lculo de mÃ©tricas
- `POST /api/actions/refresh-forecasts/` - Regenerar forecasts

**Monitoreo**:
- `GET /api/celery/status/` - Estado de workers Celery
- `GET /api/celery/scheduled/` - Tareas programadas
- `GET /api/cache/stats/` - EstadÃ­sticas de cachÃ©
- `POST /api/cache/clear/` - Limpiar cachÃ©

**Modelos**:
- `DailySalesMetrics` (fecha, total_sales, total_orders, avg_order_value)
- `ProductDemandMetrics` (producto, perÃ­odo, total_sold, avg_daily_demand, velocity)
- `InventoryTurnoverMetrics` (producto, turnover_ratio, days_to_sell, classification: A/B/C)
- `StockReorderRecommendation` (producto, reorder_point, safety_stock, recommended_qty, reorder_priority, stockout_risk)
- `ForecastAccuracyHistory` (fecha, mape, rmse, mae)
- `TaskRun` (tracking de ejecuciones de Celery)

**Tareas Celery**:
- `calculate_daily_metrics`: Agrega ventas del dÃ­a anterior
- `calculate_product_demand`: Calcula demanda de productos (Ãºltimos 30 dÃ­as)
- `calculate_inventory_turnover`: RotaciÃ³n de inventario
- `save_daily_forecasts`: Genera forecasts diarios con Prophet
- `generate_restock_recommendations`: Calcula ROP, Safety Stock, EOQ
- `update_forecast_accuracy`: Compara forecasts vs ventas reales (MAPE, RMSE, MAE)
- `cleanup_old_metrics`: Limpia datos antiguos segÃºn `ANALYTICS_RETENTION_DAYS`
- `check_service_health`: Monitorea salud de servicios dependientes

**Prometheus Metrics**:
- `analytics_forecast_requests_total`
- `analytics_forecast_duration_seconds`
- `analytics_recommendations_generated_total`
- `analytics_active_recommendations`
- `analytics_daily_sales_total`
- `analytics_forecast_accuracy_mape`
- `analytics_celery_queue_length`
- `analytics_data_quality_checks_total`

---

## ğŸ¨ Frontend

### Estructura de PÃ¡ginas (15 pÃ¡ginas)
1. **DashboardPage** (`/`) - MÃ©tricas generales, ventas, top productos, alertas crÃ­ticas
2. **AnalyticsPage** (`/analytics`) - GrÃ¡ficos avanzados de ventas y demanda
3. **ForecastingPage** (`/forecasting`) - Prophet forecasting y recomendaciones de restock
4. **ReportsPage** (`/reportes`) - Kardex, ventas, rentabilidad (PDF/Excel export)
5. **InventarioPage** (`/inventario`) - CRUD de productos, categorÃ­as, bodegas
6. **StockAlertsPage** (`/alertas-stock`) - Alertas de stock bajo con filtros
7. **ReordersPage** (`/reordenes`) - Solicitudes de reorden y seguimiento
8. **SuppliersPage** (`/proveedores`) - GestiÃ³n de proveedores y asociaciÃ³n de productos
9. **VentasPage** (`/ventas`) - Ã“rdenes de venta con filtros y estados
10. **CreateOrderPage** (`/crear-orden`) - Formulario multi-paso (orden â†’ pago â†’ envÃ­o)
11. **PersonasPage** (`/personas`) - Clientes y proveedores
12. **UsersManagementPage** (`/usuarios`) - AdministraciÃ³n de usuarios (admin only)
13. **AuditLogsPage** (`/auditoria`) - Logs de auditorÃ­a y cambios
14. **LoginPage** (`/login`) - AutenticaciÃ³n
15. **Index** (`/pages/index.tsx`) - Exportaciones centralizadas

### CaracterÃ­sticas del Frontend
- **Lazy Loading**: AnalyticsPage y ForecastingPage cargados bajo demanda
- **Protected Routes**: Todas las rutas excepto `/login` requieren autenticaciÃ³n
- **Toast Notifications**: Sistema de notificaciones global (success, error, info, warning)
- **Real-time Alerts**: Watcher de stock bajo cada 10 segundos
- **Error Boundaries**: Manejo de errores con recuperaciÃ³n graceful
- **Token Refresh**: Interceptor Axios automÃ¡tico para renovar tokens expirados
- **Auth Skip for Reports**: `/api/reports/` no envÃ­a Authorization header (AllowAny en backend)
- **Responsive Design**: Tailwind CSS con diseÃ±o mobile-first
- **Charts**: Recharts para grÃ¡ficos de lÃ­nea, barras, Ã¡rea
- **Export**: PDF (jsPDF) y Excel (XLSX) para reportes
- **Type Safety**: TypeScript con interfaces estrictas

### Servicios Frontend (services/)
- `authService.ts` - Login, logout, refresh token, perfil
- `personasService.ts` - Clientes, proveedores, bÃºsqueda
- `inventarioService.ts` - Productos, bodegas, categorÃ­as, stock, reorders
- `ventasService.ts` - Ã“rdenes, items, envÃ­os, pagos
- `forecastingService.ts` - Prophet forecasts, dashboard stats, recomendaciones
- `reportsService.ts` - Kardex, ventas, rentabilidad
- `userManagementService.ts` - GestiÃ³n de usuarios (admin)
- `suppliersService.ts` - Proveedores y asociaciÃ³n de productos
- `notificationsService.ts` - Watcher de alertas de stock
- `api.ts` - Axios client con interceptores

### Contextos (contexts/)
- `AuthContext` - Estado de autenticaciÃ³n global
- `ToastContext` - Sistema de notificaciones

---

## ğŸ”’ Seguridad

### AutenticaciÃ³n y AutorizaciÃ³n
- **JWT Tokens**: Access token (30 min), refresh token (7 dÃ­as)
- **Token Blacklist**: Tokens invalidados en logout
- **Permisos Granulares**: Decoded desde JWT, verificados en cada endpoint
- **Role-Based Access**: Admin, vendedor, bodeguero, analista
- **Session Tracking**: `UserSession` registra IP, user agent, expiraciÃ³n

### Middleware de Seguridad
- **SecurityHeadersMiddleware**: Headers de seguridad (X-Frame-Options, CSP, etc.)
- **SecurityAuditMiddleware**: DetecciÃ³n de patrones de ataque
  - XSS (script tags, event handlers)
  - SQL Injection (UNION, DROP, etc.)
  - Path Traversal (../, ..\)
  - Command Injection (shell commands)
- **RateLimitMiddleware**: LÃ­mites por IP y usuario (cache-based)
- **RequestLoggingMiddleware**: Log de todas las requests con timing
- **CORSMiddleware**: Control de orÃ­genes permitidos
- **IPWhitelistMiddleware**: RestricciÃ³n de admin endpoints por IP

### ConfiguraciÃ³n de Seguridad
```python
# HTTPS y cookies seguras
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_SSL_REDIRECT = True
SECURE_HSTS_SECONDS = 31536000

# Headers de seguridad
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# Password validation
AUTH_PASSWORD_VALIDATORS = [
    MinimumLengthValidator (12 caracteres),
    CommonPasswordValidator,
    UserAttributeSimilarityValidator,
    NumericPasswordValidator
]

# Rate limiting
DEFAULT_THROTTLE_RATES = {
    'anon': '100/hour',
    'user': '1000/hour',
    'burst': '60/minute'
}
```

### Secretos y Credenciales
- **Docker Secrets**: Almacenamiento seguro en producciÃ³n
- **Environment Variables**: `.env` para desarrollo (no comitear)
- **RotaciÃ³n de Keys**: JWT_SIGNING_KEY debe rotarse periÃ³dicamente
- **Passwords Hash**: bcrypt automÃ¡tico en Django

### AuditorÃ­a
- **Security Audit Logger**: Canal separado para eventos de seguridad
- **Request Logging**: Todas las requests con usuario, IP, mÃ©todo, path, duraciÃ³n
- **Stock Movement Audit**: `CurrentActorMiddleware` rastrea quiÃ©n hace cambios
- **Order Events**: Tracking de cambios de estado en Ã³rdenes

---

## ğŸ“Š Monitoreo y Observabilidad

### Prometheus Metrics
**Endpoint**: `http://localhost:8005/api/analytics/metrics/`

**MÃ©tricas Disponibles**:
```
# Contadores
analytics_forecast_requests_total{product_id, status}
analytics_recommendations_generated_total{priority}
analytics_data_quality_checks_total{result}
analytics_celery_task_execution_total{task_name, status}
analytics_cache_operations_total{operation, status}

# Histogramas (duraciÃ³n)
analytics_forecast_duration_seconds{forecast_type}
analytics_api_request_duration_seconds{endpoint, method}

# Gauges (estado actual)
analytics_active_recommendations{priority}
analytics_daily_sales_total
analytics_forecast_accuracy_mape{forecast_type}
analytics_celery_queue_length{queue_name}

# Info (metadatos)
analytics_service_info{version, prophet_version, environment}
```

**Uso con Prometheus**:
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'rep_drill_analytics'
    static_configs:
      - targets: ['analytics:8000']
    metrics_path: '/api/analytics/metrics/'
```

### Health Checks
**Full Health Check** (`/health/full/`):
```json
{
  "status": "healthy",
  "database": "ok",
  "redis": "ok",
  "celery_worker": "ok",
  "disk_usage": "45%",
  "memory_usage": "60%",
  "timestamp": "2025-11-01T12:00:00Z"
}
```

**Liveness Probe** (`/health/live/`):
- Verifica que el servicio responde (para Kubernetes)

**Readiness Probe** (`/health/ready/`):
- Verifica dependencias (DB, Redis) antes de recibir trÃ¡fico

### Logging
**Formato**: JSON estructurado

**Niveles**:
- `DEBUG`: Detalles de ejecuciÃ³n
- `INFO`: Operaciones normales (cÃ¡lculo de mÃ©tricas, forecasts)
- `WARNING`: Problemas no crÃ­ticos (datos faltantes, caches miss)
- `ERROR`: Errores recuperables (API timeouts, forecasts fallidos)
- `CRITICAL`: Fallos crÃ­ticos (DB down, Redis unreachable)

**Canales**:
- `django`: Logs generales de Django
- `analytics`: Logs del servicio analytics
- `celery`: Logs de tareas Celery
- `security.audit`: Eventos de seguridad

**ConfiguraciÃ³n**:
```python
LOGGING = {
    'formatters': {
        'json': {
            'class': 'pythonjsonlogger.jsonlogger.JsonFormatter',
            'format': '%(asctime)s %(name)s %(levelname)s %(message)s'
        }
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'app.log',
            'maxBytes': 10485760,  # 10MB
            'backupCount': 5,
            'formatter': 'json'
        }
    }
}
```

### Monitoreo de Celery
**Endpoints**:
- `GET /api/celery/status/` - Estado de workers
- `GET /api/celery/scheduled/` - Tareas programadas
- `GET /api/celery/active/` - Tareas en ejecuciÃ³n

**Flower** (opcional):
```powershell
docker compose exec analytics_worker celery -A servicio_analytics flower
# Acceder a http://localhost:5555
```

### Dashboards Recomendados (Grafana)
1. **System Health**: CPU, memoria, disco por servicio
2. **Request Metrics**: Latencia, throughput, tasa de error
3. **Celery Queue**: Longitud de cola, tasks completados/fallidos
4. **Forecast Accuracy**: MAPE histÃ³rico, drift detection
5. **Stock Alerts**: Alertas crÃ­ticas, recomendaciones pendientes

---

## ğŸ’» Desarrollo

### Setup Local (Sin Docker)

#### Backend (por servicio)
```powershell
cd backend/servicio_auth
python -m venv venv
.\venv\Scripts\activate
pip install -r requirements.txt

# Configurar .env
cp .env.example .env

# Migraciones
python manage.py migrate

# Crear superuser
python manage.py createsuperuser

# Ejecutar servidor
python manage.py runserver 8001

# Tests
pytest authentication/tests/ -v --cov
```

Repetir para cada servicio (personas:8004, inventario:8003, ventas:8002, analytics:8005).

#### Frontend
```powershell
cd frontend
npm install
npm run dev  # Vite dev server en http://localhost:5173
npm run build  # Build para producciÃ³n
npm run preview  # Preview del build
```

### Variables de Entorno Importantes

**Backend** (cada servicio):
```env
# Database
DATABASE_DB=rep_drill_db
DATABASE_USER=usuario
DATABASE_PASSWORD=password
DATABASE_SERVER=localhost  # 'db' en Docker
DATABASE_PORT=5432

# Django
SECRET_KEY=secret-key-here
JWT_SIGNING_KEY=jwt-key-here  # DEBE SER LA MISMA EN TODOS LOS SERVICIOS
DEBUG=True  # False en producciÃ³n
ALLOWED_HOSTS=localhost,127.0.0.1

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# URLs de otros servicios
AUTH_SERVICE_URL=http://auth:8000  # http://localhost:8001 local
VENTAS_SERVICE_URL=http://ventas:8000
INVENTARIO_SERVICE_URL=http://inventario:8000
PERSONAS_SERVICE_URL=http://personas:8000

# Redis (solo analytics)
REDIS_URL=redis://:password@redis:6379/1
CELERY_BROKER_URL=redis://:password@redis:6379/0
CELERY_RESULT_BACKEND=redis://:password@redis:6379/0

# Analytics
ANALYTICS_RETENTION_DAYS=365
ANALYTICS_CALCULATION_BATCH_SIZE=100
PROPHET_CACHE_TIMEOUT=3600
```

**Frontend**:
```env
VITE_API_BASE_URL=http://localhost  # URL del gateway Nginx
```

### Comandos Ãštiles

**Django Management**:
```powershell
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser
python manage.py shell
python manage.py collectstatic
python manage.py test
python manage.py dbshell
```

**Celery** (dentro del contenedor analytics):
```powershell
# Ver tareas registradas
celery -A servicio_analytics inspect registered

# Ver tareas activas
celery -A servicio_analytics inspect active

# Ver tareas programadas
celery -A servicio_analytics inspect scheduled

# Purge queue
celery -A servicio_analytics purge

# Flower (monitoring UI)
celery -A servicio_analytics flower
```

**Docker**:
```powershell
# Logs de un servicio
docker compose logs -f analytics

# Ejecutar comando en contenedor
docker compose exec analytics python manage.py shell

# Rebuild sin cache
docker compose build --no-cache analytics

# Ver uso de recursos
docker stats

# Limpiar todo
docker compose down -v
docker system prune -a
```

**Frontend**:
```powershell
npm run dev        # Dev server
npm run build      # Build producciÃ³n
npm run preview    # Preview build
npm run lint       # ESLint
npm run type-check # TypeScript check
```

### Testing

**Backend (pytest)**:
```powershell
# Todos los tests con coverage
pytest --cov=. --cov-report=html

# Tests especÃ­ficos
pytest authentication/tests/test_auth.py -v
pytest analytics/tests/test_forecasting.py::TestProphetForecasting::test_sales_forecast -v

# Tests en paralelo
pytest -n auto

# Tests con verbose
pytest -vv

# Tests con markers
pytest -m "slow"  # Solo tests marcados como slow
pytest -m "not slow"  # Excluir tests lentos
```

**Frontend (Vitest)**:
```powershell
npm test                 # Run tests
npm run test:watch       # Watch mode
npm run test:coverage    # Con coverage
```

### Debugging

**Backend (Django)**:
```python
# En cualquier parte del cÃ³digo
import pdb; pdb.set_trace()

# O con ipdb (mÃ¡s amigable)
import ipdb; ipdb.set_trace()

# Logging
import logging
logger = logging.getLogger(__name__)
logger.debug(f"Variable value: {var}")
```

**Frontend (React)**:
```typescript
// Console logs
console.log('Debug:', data);
console.table(users);
console.time('API call'); 
// ... cÃ³digo ...
console.timeEnd('API call');

// React DevTools (extensiÃ³n Chrome/Firefox)
// VSCode debugger con Chrome
```

**Docker Logs**:
```powershell
# Logs en tiempo real
docker compose logs -f analytics

# Ãšltimas 100 lÃ­neas
docker compose logs --tail=100 analytics

# Logs desde timestamp
docker compose logs --since 2024-11-01T10:00:00 analytics
```

---

## ğŸš€ Despliegue en ProducciÃ³n

### PreparaciÃ³n

1. **Variables de Entorno**:
```env
# .env.prod
DEBUG=False
SECRET_KEY=super-secure-random-key-min-50-chars
JWT_SIGNING_KEY=another-super-secure-key
ALLOWED_HOSTS=tudominio.com,www.tudominio.com,api.tudominio.com
CORS_ALLOWED_ORIGINS=https://tudominio.com,https://www.tudominio.com

# Database (usar instancia dedicada)
DB_NAME=rep_drill_prod
DB_USER=rep_drill_user
DB_PASSWORD=password-super-seguro-aqui
DATABASE_SERVER=db-prod.example.com
DATABASE_PORT=5432

# Redis (usar instancia dedicada)
REDIS_PASSWORD=redis-password-seguro
REDIS_URL=redis://:redis-password-seguro@redis-prod.example.com:6379/1

# SSL
SECURE_SSL_REDIRECT=True
SESSION_COOKIE_SECURE=True
CSRF_COOKIE_SECURE=True
```

2. **Configurar Docker Secrets**:
```powershell
# Crear secrets
echo "tu-secret-key-super-segura" | docker secret create django_secret_key -
echo "jwt-signing-key" | docker secret create jwt_signing_key -
echo "db-password" | docker secret create db_password -
echo "redis-password" | docker secret create redis_password -
```

3. **Actualizar docker-compose.prod.yml**:
```yaml
services:
  auth:
    secrets:
      - django_secret_key
      - jwt_signing_key
      - db_password
    environment:
      - SECRET_KEY_FILE=/run/secrets/django_secret_key
      - JWT_SIGNING_KEY_FILE=/run/secrets/jwt_signing_key
      - DB_PASSWORD_FILE=/run/secrets/db_password
```

### Despliegue con Docker Compose

```powershell
# Build todas las imÃ¡genes
docker compose -f docker-compose.prod.yml build

# Up en modo detached
docker compose -f docker-compose.prod.yml up -d

# Migraciones
docker compose -f docker-compose.prod.yml exec auth python manage.py migrate
docker compose -f docker-compose.prod.yml exec personas python manage.py migrate
docker compose -f docker-compose.prod.yml exec inventario python manage.py migrate
docker compose -f docker-compose.prod.yml exec ventas python manage.py migrate
docker compose -f docker-compose.prod.yml exec analytics python manage.py migrate

# Collectstatic
docker compose -f docker-compose.prod.yml exec auth python manage.py collectstatic --noinput
docker compose -f docker-compose.prod.yml exec analytics python manage.py collectstatic --noinput

# Crear superuser
docker compose -f docker-compose.prod.yml exec auth python manage.py createsuperuser
```

### Nginx Configuration (ProducciÃ³n)

```nginx
# /etc/nginx/conf.d/rep_drill.conf
upstream auth_backend {
    server auth:8000;
}

upstream personas_backend {
    server personas:8000;
}

upstream inventario_backend {
    server inventario:8000;
}

upstream ventas_backend {
    server ventas:8000;
}

upstream analytics_backend {
    server analytics:8000;
}

server {
    listen 80;
    server_name tudominio.com www.tudominio.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name tudominio.com www.tudominio.com;

    ssl_certificate /etc/letsencrypt/live/tudominio.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tudominio.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    client_max_body_size 100M;

    # Frontend React
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # Backend services
    location /auth/ {
        proxy_pass http://auth_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /personas/ {
        proxy_pass http://personas_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /inventario/ {
        proxy_pass http://inventario_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /ventas/ {
        proxy_pass http://ventas_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /analytics/ {
        proxy_pass http://analytics_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Static files
    location /static/ {
        alias /app/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### SSL con Let's Encrypt

```powershell
# Instalar certbot
apt install certbot python3-certbot-nginx

# Obtener certificado
certbot --nginx -d tudominio.com -d www.tudominio.com

# RenovaciÃ³n automÃ¡tica (crontab)
0 3 * * * certbot renew --quiet
```

### Monitoreo en ProducciÃ³n

**1. Prometheus + Grafana**:
```yaml
# docker-compose.monitoring.yml
services:
  prometheus:
    image: prom/prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
```

**2. Logs Centralizados (ELK Stack)**:
```yaml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    volumes:
      - ./monitoring/logstash.conf:/usr/share/logstash/pipeline/logstash.conf

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    ports:
      - "5601:5601"
```

### Backups

**PostgreSQL**:
```powershell
# Backup manual
docker compose exec db pg_dump -U usuario rep_drill_db > backup_$(date +%Y%m%d).sql

# Backup automatizado (cron)
0 2 * * * docker compose exec -T db pg_dump -U usuario rep_drill_db | gzip > /backups/rep_drill_$(date +\%Y\%m\%d).sql.gz

# Restore
docker compose exec -T db psql -U usuario rep_drill_db < backup_20251101.sql
```

**Redis**:
```powershell
# Redis hace RDB snapshots automÃ¡ticos
# Copiar /data/dump.rdb para backup
docker compose exec redis redis-cli BGSAVE
docker cp rep_drill_redis:/data/dump.rdb ./backup_redis_$(date +%Y%m%d).rdb
```

### Checklist de ProducciÃ³n

- [ ] `DEBUG=False` en todos los servicios
- [ ] `SECRET_KEY` y `JWT_SIGNING_KEY` Ãºnicos y seguros (min 50 chars)
- [ ] `ALLOWED_HOSTS` configurado correctamente
- [ ] SSL/TLS habilitado (HTTPS)
- [ ] Certificados Let's Encrypt renovÃ¡ndose automÃ¡ticamente
- [ ] CORS configurado solo para dominios de producciÃ³n
- [ ] Rate limiting habilitado
- [ ] IP whitelist para endpoints admin
- [ ] Logs configurados y rotando
- [ ] Backups automÃ¡ticos de DB y Redis
- [ ] Monitoreo con Prometheus + Grafana
- [ ] Alertas configuradas (Slack, email)
- [ ] Gunicorn con workers suficientes (2-4 x CPU cores)
- [ ] Nginx con caching de estÃ¡ticos
- [ ] PostgreSQL tuneado para producciÃ³n
- [ ] Redis con persistencia AOF habilitada
- [ ] Celery workers con autorestart
- [ ] Health checks funcionando
- [ ] Rollback plan documentado

---

## ğŸ“š API Documentation

### Acceso a DocumentaciÃ³n Interactiva

Cada servicio expone Swagger UI con drf-spectacular:

- **Auth**: http://localhost:8001/api/schema/swagger-ui/
- **Personas**: http://localhost:8004/api/schema/swagger-ui/
- **Inventario**: http://localhost:8003/api/schema/swagger-ui/
- **Ventas**: http://localhost:8002/api/schema/swagger-ui/
- **Analytics**: http://localhost:8005/api/schema/swagger-ui/

### AutenticaciÃ³n en Swagger

1. Hacer login en `POST /api/v1/auth/login/`
2. Copiar el `access` token de la respuesta
3. Hacer clic en "Authorize" (icono de candado)
4. Ingresar: `Bearer <tu_access_token>`
5. Ahora puedes probar todos los endpoints protegidos

### Ejemplos de Uso

#### 1. Login y Obtener Token
```bash
curl -X POST http://localhost/auth/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "admin123"
  }'

# Respuesta:
{
  "message": "Inicio de sesiÃ³n exitoso",
  "user": {
    "id": 1,
    "email": "admin@example.com",
    "full_name": "Admin User",
    "role": "admin"
  },
  "tokens": {
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
  }
}
```

#### 2. Crear Producto
```bash
curl -X POST http://localhost/inventario/api/products/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <access_token>" \
  -d '{
    "name": "Laptop Dell XPS 15",
    "sku": "LAPTOP-DELL-001",
    "category": 1,
    "price": "1500000",
    "cost": "1200000",
    "supplier": 1,
    "min_stock": 5,
    "max_stock": 50
  }'
```

#### 3. Crear Orden de Venta
```bash
curl -X POST http://localhost/ventas/api/orders/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <access_token>" \
  -d '{
    "customer_id": 1,
    "warehouse_id": 1,
    "status": "draft",
    "items": [
      {
        "product_id": 1,
        "quantity": 2,
        "unit_price": "1500000"
      }
    ]
  }'
```

#### 4. Confirmar Orden (Descuenta Stock)
```bash
curl -X POST http://localhost/ventas/api/orders/1/confirm/ \
  -H "Authorization: Bearer <access_token>"
```

#### 5. Obtener Forecast de Ventas
```bash
curl -X GET "http://localhost/analytics/api/prophet/sales-forecast/?periods=30" \
  -H "Authorization: Bearer <access_token>"
```

#### 6. Obtener Recomendaciones de Restock
```bash
curl -X GET "http://localhost/analytics/api/prophet/restock-recommendations/?priority=critical" \
  -H "Authorization: Bearer <access_token>"
```

#### 7. Generar Reporte Kardex (PDF/Excel)
```bash
# Obtener datos (en frontend se exporta con jsPDF/XLSX)
curl -X GET "http://localhost/analytics/api/reports/kardex/?product_id=1&warehouse_id=1" \
  # No requiere Authorization (AllowAny)
```

---

## ğŸ¤ ContribuciÃ³n

### Flujo de Trabajo
1. Fork el repositorio
2. Crear feature branch: `git checkout -b feature/nueva-funcionalidad`
3. Commit cambios: `git commit -m 'Add: nueva funcionalidad'`
4. Push a branch: `git push origin feature/nueva-funcionalidad`
5. Crear Pull Request

### EstÃ¡ndares de CÃ³digo

**Python**:
- PEP8 (usar `black` para formateo)
- Docstrings en Google style
- Type hints cuando sea posible
- Tests para funcionalidades nuevas

**TypeScript**:
- ESLint + Prettier
- Interfaces para todos los tipos
- Comentarios en lÃ³gica compleja
- Nombres descriptivos

### Tests
- Cobertura mÃ­nima: 70%
- Tests unitarios para lÃ³gica de negocio
- Tests de integraciÃ³n para APIs
- Tests E2E para flujos crÃ­ticos (login, crear orden, confirmar orden)

---

## ğŸ“„ Licencia

Este proyecto estÃ¡ bajo licencia MIT. Ver archivo `LICENSE` para mÃ¡s detalles.

---

## ğŸ“š DocumentaciÃ³n Adicional

Toda la documentaciÃ³n tÃ©cnica se encuentra en la carpeta [`docs/`](./docs/):

### GuÃ­as de Servicios
- **[`ANALYTICS_README.md`](./docs/ANALYTICS_README.md)** - Sistema de analytics y Prophet forecasting
- **[`FRONTEND_README.md`](./docs/FRONTEND_README.md)** - Arquitectura y componentes del frontend
- **[`CHATBOT_QUICKSTART.md`](./docs/CHATBOT_QUICKSTART.md)** - Inicio rÃ¡pido del chatbot con Ollama
- **[`DEPLOYMENT_CHATBOT.md`](./docs/DEPLOYMENT_CHATBOT.md)** - Despliegue del chatbot en producciÃ³n

### GuÃ­as de IntegraciÃ³n y Arquitectura Avanzada
- **[`VENTAS_PERSONAS_INTEGRATION.md`](./docs/VENTAS_PERSONAS_INTEGRATION.md)** - IntegraciÃ³n Ventas â†” Personas con cachÃ© y sincronizaciÃ³n Celery
- **[`ADVANCED_ARCHITECTURE.md`](./docs/ADVANCED_ARCHITECTURE.md)** - Reservas de stock, Saga pattern, invalidaciÃ³n de cache, mÃ©tricas granulares y multi-DB

### GuÃ­as de Datos y Testing
- **[`README_GENERADOR_DATOS.md`](./docs/README_GENERADOR_DATOS.md)** - Generador de datos de prueba
- **[`RESUMEN_GENERADOR.md`](./docs/RESUMEN_GENERADOR.md)** - Resumen del sistema de generaciÃ³n
- **[`GuÃ­a_para_Probar_y_Hacer_Build_del_Sistema_en_Docker.md`](./docs/GuÃ­a_para_Probar_y_Hacer_Build_del_Sistema_en_Docker.md)** - Testing y builds

### AnÃ¡lisis y MÃ©tricas
- **[`nps.md`](./docs/nps.md)** - Net Promoter Score y mÃ©tricas de satisfacciÃ³n

---

## ğŸ“Š Estado del Proyecto

### âœ… Completado (90%)
- Arquitectura de microservicios con 6 servicios
- AutenticaciÃ³n JWT con refresh tokens
- CRUD completo de todos los modelos
- Prophet forecasting funcional
- Dashboard con mÃ©tricas en tiempo real
- Chatbot inteligente con Ollama
- Celery tasks automatizadas
- Docker Compose orquestaciÃ³n
- Frontend React moderno

### ğŸš§ En Progreso (5%)
- Tests E2E con Playwright
- OptimizaciÃ³n de queries (select_related)
- Kubernetes manifests
- CI/CD pipeline

### âœ… Nuevas CaracterÃ­sticas Avanzadas Implementadas
- **Reservas de Stock**: Sistema de reserva previa con TTL y estados (pending/confirmed/released)
- **Saga Pattern**: Confirm/Cancel transaccional con compensaciÃ³n automÃ¡tica
- **Cache Invalidation**: InvalidaciÃ³n automÃ¡tica de pronÃ³sticos en cambios de stock
- **MÃ©tricas Granulares**: MAPE/MAE por producto y categorÃ­a para precisiÃ³n de forecasting
- **Multi-DB Scaffold**: Enrutador de bases de datos preparado para separaciÃ³n fÃ­sica futura
- **SincronizaciÃ³n Celery**: Tareas asÃ­ncronas para cachÃ© de clientes y mÃ©tricas de precisiÃ³n

### ğŸ¯ Roadmap
1. **Corto Plazo** (1-2 semanas)
   - Implementar permisos en todos los endpoints
   - Agregar rate limiting en analytics
   - Tests de concurrencia para stock
   - HTTPS con Let's Encrypt

2. **Medio Plazo** (1-2 meses)
   - React Query para estado de servidor
   - Redis Cluster para cache distribuido
   - PostgreSQL read replicas
   - Grafana dashboards

3. **Largo Plazo** (3-6 meses)
   - Event sourcing con Kafka
   - CQRS para reads/writes
   - Micro-frontends
   - ML AutoML para forecasting

---

## ğŸ“ Soporte

- **Issues**: https://github.com/JorgeFreire95/Rep-Drill/issues
- **Pull Requests**: https://github.com/JorgeFreire95/Rep-Drill/pulls
- **DocumentaciÃ³n**: [`docs/`](./docs/)
- **AnÃ¡lisis Completo**: Ver anÃ¡lisis detallado del sistema en este README

---

## ğŸ† CrÃ©ditos

**Desarrolladores** (Work Team Members):
- EliÃ¡n Farias [@RazorZX](https://github.com/RazorZX)
- Jorge Freire [@JorgeFreire95](https://github.com/JorgeFreire95)
- David Lever [@david-lever](https://github.com/david-lever)

**TecnologÃ­as Principales**:
- Django REST Framework
- React + TypeScript
- Prophet (Meta/Facebook)
- Ollama + Gemma2
- Docker + PostgreSQL + Redis

---

**Ãšltima actualizaciÃ³n**: 2025-11-20  
**VersiÃ³n**: 1.2.0  
**Estado**: ProducciÃ³n Beta

