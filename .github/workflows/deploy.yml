name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (tag or commit SHA)'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://${{ secrets.DEPLOY_HOST }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.version }}

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        script: |
          cd /app/rep_drill
          
          # Pull latest code
          git fetch origin
          git checkout ${{ github.event.inputs.version }}
          
          # Create backup
          timestamp=$(date +%Y%m%d_%H%M%S)
          mkdir -p backups
          docker-compose -f docker-compose.prod.yml exec -T db pg_dump -U postgres rep_drill_db > backups/backup_$timestamp.sql
          
          # Run deployment script
          bash deploy.sh
          
          # Run health checks
          echo "Waiting for services to be healthy..."
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -s http://localhost/health/ > /dev/null 2>&1; then
              echo "‚úì Application is healthy"
              exit 0
            fi
            
            attempt=$((attempt + 1))
            sleep 2
          done
          
          echo "‚úó Health check failed"
          exit 1

    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        
        # Test main endpoints
        BASEURL="https://${{ secrets.DEPLOY_HOST }}"
        
        # Health check
        curl -f $BASEURL/health/ || exit 1
        
        # API tests
        curl -f $BASEURL/api/cache/info/ || exit 1
        curl -f $BASEURL/api/celery/stats/ || exit 1

    - name: Notify Slack on success
      if: success()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "‚úÖ Production Deployment Successful",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Production Deployment Successful*\n*Environment:* ${{ github.event.inputs.environment }}\n*Version:* ${{ github.event.inputs.version }}\n*Deployed by:* ${{ github.actor }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Deployment"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }

    - name: Notify Slack on failure
      if: failure()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "‚ùå Production Deployment Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ö†Ô∏è Production Deployment Failed*\n*Environment:* ${{ github.event.inputs.environment }}\n*Version:* ${{ github.event.inputs.version }}\n*Initiated by:* ${{ github.actor }}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Action:* Run rollback script or check deployment logs"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Logs"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }

  # Rollback job (manual trigger after deployment)
  rollback:
    if: failure()
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Execute rollback
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        script: |
          cd /app/rep_drill
          bash rollback.sh

    - name: Notify rollback
      uses: slackapi/slack-github-action@v1.24.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "üîÑ Automatic Rollback Executed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Automatic Rollback Executed*\n*Environment:* ${{ github.event.inputs.environment }}\n*Reason:* Deployment failure detected"
                }
              }
            ]
          }
